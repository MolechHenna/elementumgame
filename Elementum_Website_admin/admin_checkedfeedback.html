<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta content="width=device-width, initial-scale=1.0" name="viewport" />

        <title>Elementum/admin</title>
        <meta content="" name="description" />
        <meta content="" name="keywords" />

        <!-- Favicons -->
        <link rel="icon" href="../images/Elementum-logo.png" />
        <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon" />

        <!-- Google Fonts -->
        <link href="https://fonts.gstatic.com" rel="preconnect" />
        <link
            href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i"
            rel="stylesheet"
        />

        <!-- Vendor CSS Files -->
        <link
            href="assets/vendor/bootstrap/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <link
            href="assets/vendor/bootstrap-icons/bootstrap-icons.css"
            rel="stylesheet"
        />
        <link
            href="assets/vendor/boxicons/css/boxicons.min.css"
            rel="stylesheet"
        />
        <link href="assets/vendor/quill/quill.snow.css" rel="stylesheet" />
        <link href="assets/vendor/quill/quill.bubble.css" rel="stylesheet" />
        <link href="assets/vendor/remixicon/remixicon.css" rel="stylesheet" />
        <link
            href="assets/vendor/simple-datatables/style.css"
            rel="stylesheet"
        />

        <!-- Template Main CSS File -->
        <link href="assets/css/style.css" rel="stylesheet" />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
        />
    </head>

    <body>
        <!-- ======= Header ======= -->
        <header id="header" class="header fixed-top d-flex align-items-center">
            <div class="d-flex align-items-center justify-content-between">
                <a
                    href="admin_index.html"
                    class="logo d-flex align-items-center"
                >
                    <img
                        src="../images/Full-logo.png"
                        alt="Topic Image"
                        style="
                            max-width: 200px;
                            max-height: 90px;
                            filter: drop-shadow(1px 2px 1px black);
                        "
                    />
                </a>
                <i class="bi bi-list toggle-sidebar-btn"></i>
            </div>
            <!-- End Logo -->
            <!-- End Search Bar -->

            <nav class="header-nav ms-auto">
                <ul class="d-flex align-items-center">
                    <li class="nav-item d-block d-lg-none">
                        <a class="nav-link nav-icon search-bar-toggle" href="#">
                            <i class="bi bi-search"></i>
                        </a>
                    </li>
                    <!-- End Search Icon-->
                    <li class="nav-item dropdown pe-3">
                        <a
                            class="nav-link nav-profile d-flex align-items-center pe-0"
                            href="#"
                            data-bs-toggle="dropdown"
                        >
                            <img
                                src="../images/Elementum-logo.png"
                                alt="Profile"
                                class="rounded-circle"
                            />
                            <span
                                id="admin-user"
                                class="d-none d-md-block dropdown-toggle ps-2"
                            ></span> </a
                        ><!-- End Profile Iamge Icon -->

                        <ul
                            class="dropdown-menu dropdown-menu-end dropdown-menu-arrow profile"
                        >
                            <li class="dropdown-header">
                                <h6>Elementum</h6>
                                <span>Application Admin</span>
                            </li>
                            <li>
                                <hr class="dropdown-divider" />
                            </li>
                            <li>
                                <a
                                    class="dropdown-item d-flex align-items-center"
                                    href="register_UIAdmin/index_register.html"
                                >
                                    <i class="bi bi-person"></i>
                                    <span>Create an Account</span>
                                </a>
                            </li>
                            <li id="logOutAdmin">
                                <a
                                    class="dropdown-item d-flex align-items-center"
                                    href="register_UIAdmin/index.html"
                                >
                                    <i class="bi bi-box-arrow-right"></i>
                                    <span id="logOutAdmin2">Sign Out</span>
                                </a>
                            </li>
                        </ul>
                        <!-- End Profile Dropdown Items -->
                    </li>
                    <!-- End Profile Nav -->
                </ul>
            </nav>
            <!-- End Icons Navigation -->
        </header>
        <!-- End Header -->

        <!-- ======= Sidebar ======= -->
<aside id="sidebar" class="sidebar">
        <ul class="sidebar-nav" id="sidebar-nav">
            <li class="nav-item">
                <a class="nav-link" href="dashboard_admin_index.html">
                    <i class="bi bi-grid"></i>
                    <span>Dashboard</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="admin_index.html">
                    <i class="bi bi-person"></i>
                    <span>Teacher Verification</span>
                </a>
            </li>
            <li class="nav-heading" style="font-weight: bold">
                Periodic Table
            </li>
            <li class="nav-item">
                <a class="nav-link" href="admin_question.html">
                    <i class="bi bi-boxes"></i>
                    <span>Periodic Table Questions</span>
                </a>
            </li>
            <li class="nav-heading" style="font-weight: bold">
                Assessments
            </li>
            <li class="nav-item">
                <a class="nav-link" href="guess_admin_index.html">
                    <i class="bi bi-question-square"></i>
                    <span>Guess the element</span>
                </a>
            </li>

            <li class="nav-item">
                <a class="nav-link" href="elemtocompound_admin_index.html">
                    <i class="bi bi-node-plus"></i>
                    <span>Elements to Compounds</span>
                </a>
            </li>
<li class="nav-heading" style="font-weight: bold">
                Feedback
            </li>
            <li class="nav-item">
                <a class="nav-link" href="admin_feedback.html">
                    <i class="fa fa-comments"></i>
                    <span>User Feedback</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="admin_checkedfeedback.html">
                    <i class="fa fa-check"></i>
                    <span>Checked Feedback</span>
                </a>
            </li>
            <li class="nav-heading" style="font-weight: bold">
                Elementum versions
            </li>
            <li class="nav-item">
                <a class="nav-link" href="apk_admin_index.html">
                    <i class="fa fa-gamepad" aria-hidden="true"></i>
                    <span>Uploading of Versions</span>
                </a>
            </li>
        </ul>
    </aside>
        <!-- End Sidebar-->

        <main id="main" class="main">
            <div class="pagetitle">
                <h1>Checked Feedbacks</h1>
                <nav>
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item">
                            <a href="index.html">Home</a>
                        </li>
                        <li class="breadcrumb-item active">Checked Feedback</li>
                    </ol>
                </nav>
            </div>
            <!-- End Page Title -->

            <section class="section dashboard">
                <div class="row">
                    <!-- Left side columns -->
                    <div class="">
                        <div class="row">
                            <div class="col-12">
                                <div class="card recent-sales overflow-auto">
                                    <div class="card-body">
                                        <br>
                                        <!-- Search bar -->
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th scope="col">Username</th>
                                                    <th scope="col">Feedback ID</th>
                                                    <th scope="col">Date</th>
                                                    <th scope="col">Feedback</th>
                                                </tr>
                                            </thead>
                                            <tbody id="tableBody">
                                                <!-- Table data will be dynamically added here -->
                                            </tbody>
                                        </table>
                                        
                                        <!-- Pagination -->
                                        <div id="pagination" class="mt-3">
                                            <ul class="pagination justify-content-center">
                                                <li class="page-item" id="prevPage">
                                                    <a class="page-link" href="#" aria-label="Previous">
                                                        <span aria-hidden="true">&laquo;</span>
                                                    </a>
                                                </li>
                                                <!-- Page number buttons will be dynamically added here -->
                                                <li class="page-item" id="nextPage">
                                                    <a class="page-link" href="#" aria-label="Next">
                                                        <span aria-hidden="true">&raquo;</span>
                                                    </a>
                                                </li>
                                            </ul>
                                            <p id="pageNumber" class="text-center mt-2"></p>
                                            <!-- Add this element to display the page number -->
                                        </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- End Left side columns -->
                </div>
            </section>
        </main>
        <!-- End #main -->

        <!-- ======= Footer ======= -->
        <footer id="footer" class="footer">
            <div class="copyright">
                &copy; Copyright <strong><span>Elementum</span></strong
                >. All Rights Reserved
            </div>
            <div class="credits"></div>
        </footer>
        <!-- End Footer -->

        <a
            href="#"
            class="back-to-top d-flex align-items-center justify-content-center"
            ><i class="bi bi-arrow-up-short"></i
        ></a>

        <!-- Vendor JS Files -->
        <script src="assets/vendor/apexcharts/apexcharts.min.js"></script>
        <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
        <script src="assets/vendor/chart.js/chart.umd.js"></script>
        <script src="assets/vendor/quill/quill.min.js"></script>
        <script src="assets/vendor/tinymce/tinymce.min.js"></script>
        <script src="assets/vendor/php-email-form/validate.js"></script>
        <script src="assets/vendor/simple-datatables/simple-datatables.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <script type="module" src="../js/firebase-observer.js"></script>
        <script type="module" src="signout.js"></script>

        <!-- Template Main JS File -->
        <script src="assets/js/main.js"></script>
<script type="module">
    // Import the functions you need from the SDKs you need
    import { firebaseConfig } from "/js/firebase-config.js";
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
    import {
        getDatabase,
        ref,
        onValue,
        remove,
        set,
        update,
    } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-database.js";
    import {
        getAuth,
        signInWithEmailAndPassword,
        deleteUser as deleteAuthUser,
    } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js";
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase();
    const usersRef = ref(db, "users"); // Reference to the "users" node in the database
    const feedbacksRef = ref(db, "Feedbacks"); // Reference to the "Feedbacks" node in the database
    const tableBody = document.querySelector("table tbody");

    // Pagination variables
    const ITEMS_PER_PAGE = 10; // Number of items to display per page
    let currentPage = 1;

    // Function to handle pagination and display the correct rows
    function updateTablePagination() {
        const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
        const endIndex = startIndex + ITEMS_PER_PAGE;

        const rows = tableBody.querySelectorAll("tr");
        rows.forEach((row, index) => {
            if (index >= startIndex && index < endIndex) {
                row.style.display = "";
            } else {
                row.style.display = "none";
            }
        });

        // Calculate the total number of pages
        const totalPageCount = Math.ceil(rows.length / ITEMS_PER_PAGE);

        // Update the pagination buttons
        const prevPageButton = document.getElementById("prevPage");
        const nextPageButton = document.getElementById("nextPage");
        const pageNumber = document.getElementById("pageNumber");

        if (currentPage === 1) {
            prevPageButton.classList.add("disabled");
        } else {
            prevPageButton.classList.remove("disabled");
        }

        if (endIndex >= rows.length) {
            nextPageButton.classList.add("disabled");
        } else {
            nextPageButton.classList.remove("disabled");
        }

        // Display the page number and the total number of pages
        pageNumber.textContent = `Page ${currentPage} of ${totalPageCount}`;
    }

// Function to populate the feedback table
function populateFeedbackTable() {
    tableBody.innerHTML = ''; // Clear existing table data

    // Fetch data from Firebase
    onValue(feedbacksRef, (snapshot) => {
        const feedbacksData = snapshot.val();

        if (feedbacksData) {
            // Flatten the feedbacksData into an array for sorting
            const feedbacksArray = [];
            Object.keys(feedbacksData).forEach((username) => {
                Object.keys(feedbacksData[username]).forEach((uid) => {
                    const { dateOfUpload, feedback, isRead } = feedbacksData[username][uid];
                    
                    // Filter out entries with isRead: true
                    if (isRead) {
                        feedbacksArray.push({ username, uid, dateOfUpload, feedback });
                    }
                });
            });

            // Sort the array by date
            feedbacksArray.sort((a, b) => new Date(b.dateOfUpload) - new Date(a.dateOfUpload));

            // Iterate through the sorted array and append data to the table
            feedbacksArray.forEach(({ username, uid, dateOfUpload, feedback }) => {
                // Truncate feedback
                const truncatedFeedback = feedback.length > 30 ? `${feedback.slice(0, 30)}...` : feedback;

                appendRowToFeedbackTable(username, uid, dateOfUpload, feedback);
            });
        } else {
            console.log('No feedback data found');
        }

        // After populating, update pagination
        updateTablePagination();
    });
}

// Function to append a row to the feedback table
function appendRowToFeedbackTable(username, uid, dateOfUpload, feedback) {
    const row = document.createElement('tr');
    row.innerHTML = `
        <td>${username}</td>
        <td>${uid}</td>
        <td>${dateOfUpload}</td>
        <td>${feedback}</td>
    `;
    tableBody.appendChild(row);
}

// Function to sanitize a UID by replacing invalid characters
function sanitizeUid(uid) {
    // Replace invalid characters with a safe character, e.g., "_"
    return uid.replace(/[.#$[\]]/g, "_");
}

// Function to update the isRead node in the Firebase database
function updateIsReadNode(username, uid) {
    const sanitizedUid = sanitizeUid(uid);
    const feedbackRef = ref(db, `Feedbacks/${username}/${sanitizedUid}`);

    // Use the update function to add the isRead node
    update(feedbackRef, { isRead: true }).then(() => {
        console.log(`isRead node for UID ${sanitizedUid} added successfully`);
        // Show SweetAlert for successful update
        Swal.fire({
            title: 'Marked as Read!',
            text: 'The feedback has been marked as read.',
            icon: 'success'
        });
    }).catch((error) => {
        console.error('Error adding isRead node:', error);
        // Show SweetAlert for error
        Swal.fire({
            title: 'Error!',
            text: 'An error occurred while adding the isRead node.',
            icon: 'error'
        });
    });
}

    // Populate the feedback table when the page loads
    document.addEventListener('DOMContentLoaded', () => {
        populateFeedbackTable();
    });


    // Event listener for previous and next page buttons
    document.getElementById("prevPage").addEventListener("click", () => {
        if (currentPage > 1) {
            currentPage--;
            updateTablePagination();
        }
    });

    document.getElementById("nextPage").addEventListener("click", () => {
        const rows = tableBody.querySelectorAll("tr");
        const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
        const endIndex = startIndex + ITEMS_PER_PAGE;

        if (endIndex < rows.length) {
            currentPage++;
            updateTablePagination();
        }
    });
    
    // Function to open a modal and display feedback details
    function openFeedbackModal(feedbackDetails) {
        // Get modal elements
        const modal = new bootstrap.Modal(document.getElementById('feedbackModal'));
        const modalBody = document.getElementById('feedbackModalBody');

        // Populate modal body with feedback details
        modalBody.innerHTML = `
            <p><strong>Username:</strong> ${feedbackDetails.username}</p>
            <p><strong>UID:</strong> ${feedbackDetails.uid}</p>
            <p><strong>Date of Upload:</strong> ${feedbackDetails.dateOfUpload}</p>
            <p><strong>Feedback:</strong> ${feedbackDetails.feedback}</p>
        `;

        // Open the modal
        modal.show();
    }
    
        
</script>

        <script>
            function getCookie(cookieName) {
                const name = cookieName + "=";
                const decodedCookie = decodeURIComponent(document.cookie);
                const cookieArray = decodedCookie.split(";");
                for (let i = 0; i < cookieArray.length; i++) {
                    let cookie = cookieArray[i];
                    while (cookie.charAt(0) === " ") {
                        cookie = cookie.substring(1);
                    }
                    if (cookie.indexOf(name) === 0) {
                        return cookie.substring(name.length, cookie.length);
                    }
                }
                return null;
            }

            const userDataString = getCookie("userDataAdmin");
            const lessonsDataTeacher = getCookie("lessonsData");

            if (userDataString) {
                try {
                    const userData = JSON.parse(userDataString);

                    console.log("Email:", userData.email);
                    const isLoggedIn = userData.username;

                    const accountNameElement =
                        document.getElementById("admin-user");

                    if (isLoggedIn !== "") {
                        accountNameElement.textContent = userData.username;
                    }else{
                        window.location.href = 'register_UIAdmin/index.html';
                    }
                } catch (error) {
                    console.error("Error parsing JSON:", error);
                }
            } else {
                console.log("Cookie not found");
            }

        </script>

    </body>
</html>