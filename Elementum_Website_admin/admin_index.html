<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />

    <title>Elementum/admin</title>
    <meta content="" name="description" />
    <meta content="" name="keywords" />

    <!-- Favicons -->
    <link rel="icon" href="../images/Elementum-logo.png" />
    <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon" />

    <!-- Google Fonts -->
    <link href="https://fonts.gstatic.com" rel="preconnect" />
    <link
        href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i"
        rel="stylesheet" />

    <!-- Vendor CSS Files -->
    <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
    <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet" />
    <link href="assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet" />
    <link href="assets/vendor/quill/quill.snow.css" rel="stylesheet" />
    <link href="assets/vendor/quill/quill.bubble.css" rel="stylesheet" />
    <link href="assets/vendor/remixicon/remixicon.css" rel="stylesheet" />
    <!-- Template Main CSS File -->
    <link href="assets/css/style.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
</head>

<body>
    <!-- ======= Header ======= -->
    <header id="header" class="header fixed-top d-flex align-items-center">
        <div class="d-flex align-items-center justify-content-between">
            <a href="admin_index.html" class="logo d-flex align-items-center">
                <img src="../images/Full-logo.png" alt="Topic Image" style="
                            max-width: 200px;
                            max-height: 90px;
                            filter: drop-shadow(1px 2px 1px black);
                        " />
            </a>
            <i class="bi bi-list toggle-sidebar-btn"></i>
        </div>
        <!-- End Logo -->
        <!-- End Search Bar -->

        <nav class="header-nav ms-auto">
            <ul class="d-flex align-items-center">
                <!-- End Search Icon-->
                <li class="nav-item dropdown pe-3">
                    <a class="nav-link nav-profile d-flex align-items-center pe-0" href="#" data-bs-toggle="dropdown">
                        <img src="../images/Elementum-logo.png" alt="Profile" class="rounded-circle" />
                        <span id="admin-user" class="d-none d-md-block dropdown-toggle ps-2">Elementum</span>
                    </a><!-- End Profile Iamge Icon -->

                    <ul class="dropdown-menu dropdown-menu-end dropdown-menu-arrow profile">
                        <li class="dropdown-header">
                            <h6>Elementum</h6>
                            <span>Application Admin</span>
                        </li>
                        <li>
                            <hr class="dropdown-divider" />
                        </li>
                        <li>
                                <a
                                    class="dropdown-item d-flex align-items-center"
                                    href="register_UIAdmin/index_register.html"
                                >
                                    <i class="bi bi-person"></i>
                                    <span>Create an Account</span>
                                </a>
                            </li>
                        <li id="logOutAdmin">
                            <a class="dropdown-item d-flex align-items-center" href="register_UIAdmin/index.html">
                                <i class="bi bi-box-arrow-right"></i>
                                <span id="logOutAdmin">Sign Out</span>
                            </a>
                        </li>
                    </ul>
                    <!-- End Profile Dropdown Items -->
                </li>
                <!-- End Profile Nav -->
            </ul>
        </nav>
        <!-- End Icons Navigation -->
    </header>
    <!-- End Header -->

          <!-- ======= Sidebar ======= -->
<aside id="sidebar" class="sidebar">
        <ul class="sidebar-nav" id="sidebar-nav">
            <li class="nav-item">
                <a class="nav-link" href="dashboard_admin_index.html">
                    <i class="bi bi-grid"></i>
                    <span>Dashboard</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="admin_index.html">
                    <i class="bi bi-person-fill"></i>
                    <span>Teacher Verification</span>
                </a>
            </li>
            <li class="nav-heading" style="font-weight: bold">
                Periodic Table
            </li>
            <li class="nav-item">
                <a class="nav-link" href="admin_question.html">
                    <i class="bi bi-boxes"></i>
                    <span>Periodic Table Questions</span>
                </a>
            </li>
            <li class="nav-heading" style="font-weight: bold">
                Assessments
            </li>
            <li class="nav-item">
                <a class="nav-link" href="guess_admin_index.html">
                    <i class="bi bi-question-square"></i>
                    <span>Guess the element</span>
                </a>
            </li>

            <li class="nav-item">
                <a class="nav-link" href="elemtocompound_admin_index.html">
                    <i class="bi bi-node-plus"></i>
                    <span>Elements to Compounds</span>
                </a>
            </li>

<li class="nav-heading" style="font-weight: bold">
                Feedback
            </li>
            <li class="nav-item">
                <a class="nav-link" href="admin_feedback.html">
                    <i class="fa fa-comments"></i>
                    <span>User Feedback</span>
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="admin_checkedfeedback.html">
                    <i class="fa fa-check"></i>
                    <span>Checked Feedback</span>
                </a>
            </li>
            <li class="nav-heading" style="font-weight: bold">
                Elementum versions
            </li>
            <li class="nav-item">
                <a class="nav-link" href="apk_admin_index.html">
                    <i class="fa fa-gamepad" aria-hidden="true"></i>
                    <span>Uploading of Versions</span>
                </a>
            </li>
        </ul>
    </aside>
        <!-- End Sidebar-->

    <main id="main" class="main">
        <div class="pagetitle">
            <h1>Teacher Verification</h1>
            <nav>
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="index.html">Home</a>
                    </li>
                    <li class="breadcrumb-item active">
                        Teacher Verification
                    </li>
                </ol>
            </nav>
        </div>
        <!-- End Page Title -->

        <section class="section dashboard">
            <div class="row">
                <!-- Left side columns -->
                <div class="">
                    <div class="row">
                        <!-- Recent Sales -->
                        <div class="col-12">
                            <div class="card recent-sales overflow-auto">
                                <div class="card-body">
                                    <h5 class="card-title">
                                        Pending Accounts
                                    </h5>

                                    <!-- Search bar -->
                                    <!-- Search bar -->
                                    <input type="text" id="searchInput" placeholder="Search for a user..."
                                        class="form-control mb-3" />

                                    <table class="table table-borderless datatable">
                                        <thead>
                                            <tr>
                                                <th scope="col">UID</th>
                                                <th scope="col">Email</th>
                                                <th scope="col">
                                                    Username
                                                </th>
                                                <th scope="col">
                                                    Account Type
                                                </th>
                                                <th scope="col">Status</th>
                                                <th scope="col">Verify</th>
                                                <th scope="col">Delete</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tableBody">
                                            <!-- Table data will be dynamically added here -->
                                        </tbody>
                                    </table>

                                    <!-- Pagination -->
                                    <div id="pagination" class="mt-3">
                                        <ul class="pagination justify-content-center">
                                            <li class="page-item" id="prevPage">
                                                <a class="page-link" href="#" aria-label="Previous">
                                                    <span aria-hidden="true">&laquo;</span>
                                                </a>
                                            </li>
                                            <!-- Page number buttons will be dynamically added here -->
                                            <li class="page-item" id="nextPage">
                                                <a class="page-link" href="#" aria-label="Next">
                                                    <span aria-hidden="true">&raquo;</span>
                                                </a>
                                            </li>
                                        </ul>
                                        <p id="pageNumber" class="text-center mt-2"></p>
                                        <!-- Add this element to display the page number -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- End Recent Sales -->
                    </div>
                </div>
                <!-- End Left side columns -->
            </div>
        </section>
    </main>
    <!-- End #main -->

    <!-- ======= Footer ======= -->
    <footer id="footer" class="footer">
        <div class="copyright">
            &copy; Copyright <strong><span>Elementum</span></strong>. All Rights Reserved
        </div>
        <div class="credits"></div>
    </footer>
    <!-- End Footer -->

    <a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i
            class="bi bi-arrow-up-short"></i></a>

    <!-- Vendor JS Files -->
    <script src="assets/vendor/apexcharts/apexcharts.min.js"></script>
    <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="assets/vendor/chart.js/chart.umd.js"></script>
    <script src="assets/vendor/quill/quill.min.js"></script>
    <script src="assets/vendor/tinymce/tinymce.min.js"></script>
    <script src="assets/vendor/php-email-form/validate.js"></script>
    <script type="module" src="../../js/firebase-observer.js"></script>
    <script type="module" src="../../js/signout.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <!-- Template Main JS File -->
    <script src="assets/js/main.js"></script>
    <script type="module">
    emailjs.init("hwzKl9tFxEKQ9EAti");
</script>
    <script type="module">
        // Import the functions you need from the SDKs you need

        import { firebaseConfig } from "../js/firebase-config.js";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
        import {
            getDatabase,
            ref,
            onValue,
            remove,
            set,
        } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-database.js";

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase();
        const usersRef = ref(db, "users"); // Reference to the "users" node in the database
        const tableBody = document.querySelector("table tbody");
        const searchInput = document.querySelector("#searchInput");

        // Pagination variables
        const ITEMS_PER_PAGE = 10; // Number of items to display per page
        let currentPage = 1;

        // Function to handle pagination and display the correct rows
        function updateTablePagination() {
            const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
            const endIndex = startIndex + ITEMS_PER_PAGE;

            const rows = tableBody.querySelectorAll("tr");
            rows.forEach((row, index) => {
                if (index >= startIndex && index < endIndex) {
                    row.style.display = "";
                } else {
                    row.style.display = "none";
                }
            });

            // Calculate the total number of pages
            const totalPageCount = Math.ceil(rows.length / ITEMS_PER_PAGE);

            // Update the pagination buttons
            const prevPageButton = document.getElementById("prevPage");
            const nextPageButton = document.getElementById("nextPage");
            const pageNumber = document.getElementById("pageNumber");

            if (currentPage === 1) {
                prevPageButton.classList.add("disabled");
            } else {
                prevPageButton.classList.remove("disabled");
            }

            if (endIndex >= rows.length) {
                nextPageButton.classList.add("disabled");
            } else {
                nextPageButton.classList.remove("disabled");
            }

            // Display the page number and the total number of pages
            pageNumber.textContent = `Page ${currentPage} of ${totalPageCount}`;
        }

        // Event listener for previous and next page buttons
        document
            .getElementById("prevPage")
            .addEventListener("click", () => {
                if (currentPage > 1) {
                    currentPage--;
                    updateTablePagination();
                }
            });

        document
            .getElementById("nextPage")
            .addEventListener("click", () => {
                const rows = tableBody.querySelectorAll("tr");
                const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
                const endIndex = startIndex + ITEMS_PER_PAGE;

                if (endIndex < rows.length) {
                    currentPage++;
                    updateTablePagination();
                }
            });

        function retrieveTeacherData() {
            onValue(usersRef, (snapshot) => {
                tableBody.innerHTML = ""; // Clear the table

                // Loop through each user in the "users" node
                snapshot.forEach((childSnapshot) => {
                    const uid = childSnapshot.key;
                    const userData = childSnapshot.val();

                    // Check if the user is a teacher (isTeacher is true)
                    if (userData.isTeacher) {
                        populateTable(uid, userData);
                    }
                });
            });
        }

        retrieveTeacherData(); // Call this function to initially populate the table with teacher data

// Attach event listeners for the new buttons
function attachEventListeners() {
    tableBody.addEventListener("click", (event) => {
        const target = event.target;

        if (target.classList.contains("verify-button")) {
            const uid = target.getAttribute("data-uid");
            const userEmail = target.getAttribute("data-email");
            const username = target.getAttribute("data-username");

            // Now you can use userEmail and username as needed
            verifyUser(uid, userEmail, username);
        }

        if (target.classList.contains("delete-button")) {
            const uid = target.getAttribute("data-uid");
            deleteUser(uid);
        }
    });
}

function verifyUser(uid, userEmail, username) {
    Swal.fire({
        title: 'Verify User',
        text: 'Are you sure you want to verify this user?',
        icon: 'question',
        showCancelButton: true,
    }).then((result) => {
        if (result.isConfirmed) {
            const userRef = ref(db, `users/${uid}/isVerified`);
            set(userRef, true);

            // Call the sendVerificationEmail function
            sendVerificationEmail(userEmail, username);

            Swal.fire({
                title: 'User Verified!',
                text: 'The user has been successfully verified.',
                icon: 'success',
            });
        }
    });
}

// Function to send verification email using Email.js
function sendVerificationEmail(userEmail, username) {
    const templateParams = {
        to_email: userEmail,
        to_name: username,
    };
    emailjs.send("service_vzqkwq4", "template_806q55n", templateParams)
        .then((response) => {
            console.log("Email sent successfully", response);
        })
        .catch((error) => {
            console.error("Error sending email", error);
            console.log(error.status, error.text);
        });
}



        // Function to delete a user
        function deleteUser(uid) {
            Swal.fire({
                title: "Delete User",
                text: "Are you sure you want to delete this user?",
                icon: "question",
                showCancelButton: true,
            }).then((result) => {
                if (result.isConfirmed) {
                    const userRef = ref(db, `users/${uid}`);
                    remove(userRef)
                        .then(() => {
                            Swal.fire(
                                "User Deleted",
                                "The user has been deleted.",
                                "success"
                            );
                        })
                        .catch((error) => {
                            Swal.fire(
                                "Error",
                                "An error occurred while deleting the user from the database.",
                                "error"
                            );
                        });
                }
            });
        }

        // Function to populate the table with user data
        // Function to populate the table with user data
        function populateTable(uid, data) {
            // Check if the user is verified, if so, don't add the row
            if (data.isVerified) {
                return;
            }

            if (!tableBody) {
                console.error("Table body not found.");
                return;
            }

            const tr = document.createElement("tr");

            tr.innerHTML = `
        <td>${uid}</td>
        <td>${data.email}</td>
        <td>${data.username}</td>
        <td>${data.username === "Elementum"
                    ? "Admin"
                    : data.isTeacher
                        ? "Teacher"
                        : "Student"
                }</td>
        <td>
            <span class="badge bg-${data.isVerified ? "success" : "warning"}">
                ${data.isVerified ? "Verified" : "Pending"}
            </span>
        </td>
        <td>
        ${data.isVerified
                    ? ""
                    : `<button class="verify-button btn btn-success" data-uid="${uid}" data-email="${data.email}" data-username="${data.username}">Verify</button>`
                }
    </td>
        <td>
            <button class="delete-button btn btn-danger" data-uid="${uid}">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    `;

            // Append the row to the table body
            tableBody.appendChild(tr);

            // Sort the table rows based on verification status
            sortTable();

                // Check if the table is empty and add a "No data found" message
    const rows = tableBody.querySelectorAll("tr");
    if (rows.length === 0) {
        const noDataRow = document.createElement("tr");
        const noDataCell = document.createElement("td");
        noDataCell.setAttribute("colspan", "7"); // Adjust the colspan based on the number of columns
        noDataCell.style.fontSize = "18px"; // Adjust the font size as needed
        noDataCell.style.textAlign = "center";
        noDataCell.textContent = "No data found";
        noDataRow.appendChild(noDataCell);
        tableBody.appendChild(noDataRow);
    }

    // Attach event listeners after creating buttons
    attachEventListeners();
        }

        function sortTable() {
            const rows = Array.from(tableBody.querySelectorAll("tr"));

            rows.sort((a, b) => {
                const statusA = getStatusOrder(a);
                const statusB = getStatusOrder(b);

                return statusA - statusB;
            });

            // Remove existing rows from the table
            rows.forEach((row) => tableBody.removeChild(row));

            // Append the sorted rows back to the table
            rows.forEach((row) => tableBody.appendChild(row));
        }

        function getStatusOrder(row) {
            const statusText = row
                .querySelector(".badge")
                .textContent.trim()
                .toLowerCase();

            // Assign order based on the verification status
            switch (statusText) {
                case "pending":
                    return 1;
                case "verified":
                    return 2;
                default:
                    return 3; // For any other status, consider it last
            }
        }

        // Event listener for the search input
        searchInput.addEventListener("input", () => {
            const searchValue = searchInput.value.toLowerCase();
            const rows = tableBody.querySelectorAll("tr");

            rows.forEach((row) => {
                const username = row
                    .querySelector("td:nth-child(3)")
                    .textContent.toLowerCase();
                if (username.includes(searchValue)) {
                    row.style.display = "table-row";
                } else {
                    row.style.display = "none";
                }
            });
        });

        // Attach event listeners for the new buttons
        tableBody.addEventListener("click", (event) => {
            const target = event.target;

            if (target.classList.contains("verify-button")) {
                const uid = target.getAttribute("data-uid");
                const userEmail = target.getAttribute("data-email");
                const username = target.getAttribute("data-username");

                // You can call the verifyUser function here if needed
                verifyUser(uid);
            }

            if (target.classList.contains("delete-button")) {
                const uid = target.getAttribute("data-uid");
                deleteUser(uid);
            }
        });
    </script>
    <script>
        function getCookie(cookieName) {
            const name = cookieName + "=";
            const decodedCookie = decodeURIComponent(document.cookie);
            const cookieArray = decodedCookie.split(";");
            for (let i = 0; i < cookieArray.length; i++) {
                let cookie = cookieArray[i];
                while (cookie.charAt(0) === " ") {
                    cookie = cookie.substring(1);
                }
                if (cookie.indexOf(name) === 0) {
                    return cookie.substring(name.length, cookie.length);
                }
            }
            return null;
        }

        const userDataString = getCookie("userDataAdmin");
        const lessonsDataTeacher = getCookie("lessonsData");

        if (userDataString) {
            try {
                const userData = JSON.parse(userDataString);
                const isLoggedIn = userData.username;

                const accountNameElement =
                    document.getElementById("admin-user");

                if (isLoggedIn !== "") {
                    accountNameElement.textContent = userData.username;
                }
            } catch (error) {
                console.error("Error parsing JSON:", error);
            }
        } else {
            console.log("Cookie not found");
        }

        if (lessonsDataTeacher) {
            try {
                const lessonsData = JSON.parse(lessonsDataTeacher);
                console.log("FileName:", lessonsData);
            } catch (error) {
                console.error("Error parsing JSON:", error);
            }
        } else {
            console.log("Cookie not found");
        }
    </script>
</body>

</html>