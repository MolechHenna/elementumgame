<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta name="description" content="" />
    <meta name="author" content="" />
<meta name="google-adsense-account" content="ca-pub-7801318214806091">
    <title>Elementum/Upload</title>

    <!--===============================================================================================-->
    <link rel="icon" href="../images/Elementum-logo.png" />
    <!--===============================================================================================-->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="../register_UI/vendor/bootstrap/css/bootstrap.min.css" />
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="../register_UI/fonts/font-awesome-4.7.0/css/font-awesome.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@700&family=Lilita+One&display=swap"
        rel="stylesheet" />
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="../register_UI/vendor/animate/animate.css" />
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="../register_UI/vendor/css-hamburgers/hamburgers.min.css" />
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="../register_UI/vendor/select2/select2.min.css" />
    <!--===============================================================================================-->
    <link rel="stylesheet" type="text/css" href="../register_UI/css/util.css" />
    <link rel="stylesheet" type="text/css" href="../register_UI/css/main.css" />
    <!--===============================================================================================-->
    <style>
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #3E095C;
            /* Adjust the background color and opacity as needed */
            z-index: 9999;
            /* Ensure it's above other content */
            text-align: center;
        }

        .overlay-content {
            border-radius: 40px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
</head>

<body>
    <div id="preloader"></div>
    <div class="limiter">
        <div class="container-login100">
                        <div class="wrap-login100" style="  border: 10px solid rgb(0, 0, 0);
  border-bottom: 20px solid rgb(0, 0, 0); border-radius: 50px;">
                <style>
                    @media (max-width: 800px) {
                        .wrap-login100 {
                            padding-top: 40px;
                            }
                        .p-t-136{
                            padding-top: 0;
                            }  
                        .login100-form-title {
                              padding-bottom: 20px;
                              font-size: 20px;
                        }
                    }
                </style>
                <div class="login100-pic js-tilt" data-tilt>
                    <img src="../register_UI/images/lesson_book.png" alt="IMG" />
                </div>
                <style>
                    /* Add CSS rules to limit the width and truncate text */
                    .custom-file-label {
                        white-space: nowrap;
                        overflow: hidden;
                        text-overflow: ellipsis;
                        max-width: 100%;
                        /* Adjust the value as needed */
                    }
                </style>
                <form class="login100-form validate-form" id="file-upload-form">
                    <span class="login100-form-title"> UPLOAD LESSON </span>

                    <div class="form-group">
                        <div class="custom-file">
                            <input type="file" class="form-control-file custom-file-input" id="file-input" name="file"
                                required />
                            <label class="custom-file-label" for="file-input" id="file-label">Choose File</label>
                            <script>
                                const uploadField =
                                    document.getElementById("file-input");

                                uploadField.onchange = function () {
                                    if (this.files[0].size > 100000000) {
                                        alert("File is too big!");
                                        this.value = "";
                                    }
                                };

                                uploadField.addEventListener("change", function () {
                                    if (this.files.length > 0) {
                                        const file = this.files[0];
                                        if (!file.name.includes("Elementum")) {
                                            alert("File must contain the word 'Elementum' in the filename.");
                                            this.value = "";
                                        }
                                    }
                                });
                            </script>
                        </div>
                        <div class="error-message" id="error-message" style="color: red; display: true">
                            PDF, PPT, and DOC file types only
                            <br>(100MB File size)
                        </div>
                    </div>
                    <div class="container-login100-form-btn">
                        <button type="submit" class="login100-form-btn">
                            Upload
                        </button>
                    </div>

                   <div class="container-login100-form-btn">
                        <a class="login100-form-back-btn" style="color: white;"onclick="goBack()">
                            Back
                        </a>
                    </div>
                    <script>
                        function goBack() {
                            window.history.back();
                        }
                    </script>
                    <div class="text-center p-t-136">
                        <a class="txt2" href="https://play.google.com/store/games?hl=en&gl=US&pli=1">
                        </a>
                    </div>
                </form>
                <div id="overlay" class="overlay">
                    <div class="overlay-content">
                        <img src="../images/cooler_loading.gif" alt="Loading..." />
                    </div>
                </div>

                <script>
                    // Get the file input, the label, and the error message
                    const fileInput1 =
                        document.getElementById("file-input");
                    const fileLabel = document.getElementById("file-label");
                    const errorMessage =
                        document.getElementById("error-message");

                    // Add an event listener to the file input
                    fileInput1.addEventListener("change", () => {
                        const selectedFile = fileInput1.files[0];
                        if (selectedFile) {
                            if (selectedFile.name.match(/\.(pdf|ppt|pptx|doc|docx)$/i)) {
                                // File is valid, update the label
                                fileLabel.innerText = selectedFile.name;
                                errorMessage.style.display = "none";
                            } else {
                                // Invalid file, show error message and reset input
                                fileLabel.innerText = "Choose File";
                                errorMessage.style.display = "block";
                                fileInput1.value = ""; // Clear the input
                            }
                        }
                    });
                </script>
            </div>
        </div>
    </div>
    <div id="upload-progress" style="display: none">
        <p>Uploading...</p>
        <progress id="progress-bar" max="100" value="0"></progress>
    </div>

    <div id="upload-success" style="display: none">
        <p>Upload Successful!</p>
    </div>

    <!-- <script type="module" src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.5.0/firebase-storage.js"></script> -->

    <script type="module">
        import { firebaseConfig } from "/js/firebase-config.js";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
        import {
            getStorage,
            ref as storageRef,
            uploadBytes,
        } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-storage.js";
        import {
            getDatabase,
            ref,
            get,
            set,
        } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-database.js";
        import { getCookie } from "/js/cookie-getter.js";

const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const storage = getStorage(app);

    // Initial check when the page loads
    document.addEventListener("DOMContentLoaded", async () => {
        try {
            const userDataString = getCookie("userData");
            if (userDataString) {
                const userData = JSON.parse(userDataString);

                // Check if user is a teacher
                if (userData.isTeacher === false) {
                    // If not a teacher, redirect to the previous page or handle as needed
                    window.history.back();
                } else {
                    // Continue with the rest of your code (form setup, event listeners, etc.)
                    setupForm();
                }
            } else {
                console.log("Cookie not found");
                // Handle the case where userData is not found as needed
            }
        } catch (error) {
            console.error("Error during initial check:", error);
            // Handle the error as needed
        }
    });

    function setupForm() {
        // Continue with the rest of your code (form setup, event listeners, etc.)
        const form = document.getElementById("file-upload-form");
        const fileInput = document.getElementById("file-input");
        const uploadProgress = document.getElementById("upload-progress");
        const progressBar = document.getElementById("progress-bar");
        const uploadSuccess = document.getElementById("upload-success");

        form.addEventListener("submit", (e) => {
            e.preventDefault();
            const file = fileInput.files[0];
            if (file) {
                checkAndUploadFile(file);
            }
        });

        const uploadButton = document.querySelector(".login100-form-btn");
        const overlay = document.getElementById("overlay");

        // Add an event listener to the upload button
        uploadButton.addEventListener("click", (e) => {
            e.preventDefault();

            // Show the overlay
            overlay.style.display = "block";

            const file = fileInput.files[0];
            if (file) {
                checkAndUploadFile(file);
            }
        });
    }
        
async function checkAndUploadFile(file) {
    const filename = file.name;
    const lessonsRef = ref(database, "lessons");

    try {
        const userDataString = getCookie("userData");
        if (userDataString) {
            const userData = JSON.parse(userDataString);

            // Check if user is a teacher
            if (userData.isTeacher === false) {
                // If not a teacher, redirect to the previous page or handle as needed
                window.history.back();
                return;
            }

            const username = userData.username;

            const snapshot = await get(lessonsRef);
            const lessonsData = snapshot.val() || {};

            if (!Object.prototype.hasOwnProperty.call(lessonsData, username)) {
                lessonsData[username] = [];
            }

            let userLessons = lessonsData[username];

            // Ensure userLessons is an array
            if (!Array.isArray(userLessons)) {
                userLessons = [];
            }

            const currentDate = new Date().toISOString().split('T')[0]; // Get the current date without the time

            // Push the filename and date as an object to the array
            userLessons.push({ filename, date: currentDate });

            const storageReference = storageRef(
                storage,
                `lessons/${username}/${filename}`
            );
            const uploadTask = uploadBytes(storageReference, file);

            await uploadTask;

            // Hide the overlay after the upload is complete
            overlay.style.display = "none";

            // Show a success SweetAlert notification with options
            const result = await Swal.fire({
                title: "Success",
                text: "File has been successfully uploaded!",
                icon: "success",
                showCancelButton: true,
                confirmButtonText: "Upload Another",
                cancelButtonText: "Go Back",
            });

            if (result.isConfirmed) {
                // User chose to upload another file
                location.reload(); // You might want to change this to your specific logic
            } else {
                // User chose to go back
                // You can redirect to another page or perform any other action
                window.history.back();
            }

            // Update the lessons data in the database with the new entry
            set(lessonsRef, lessonsData);
        } else {
            console.log("Cookie not found");
            overlay.style.display = "none";
        }
    } catch (error) {
        console.error("Error checking or uploading the file:", error);
        overlay.style.display = "none";

        // Show an error SweetAlert notification
        await Swal.fire({
            title: "Error",
            text: "An error occurred while uploading the file.",
            icon: "error",
        });
    }
}
    </script>
    <script>
        var loader = document.getElementById("preloader");

        window.addEventListener("load", function () {
            loader.style.display = "none";
        });
    </script>
</body>

</html>